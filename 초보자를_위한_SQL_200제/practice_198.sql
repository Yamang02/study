-- ■ 예제_198. SQL로 머신러닝 구현하기20(APRIORI)

-- 1. 머신러닝 모델이 학습할 테이블을 생성합니다.

DROP TABLE ONLINE_RETAIL; 

CREATE TABLE ONLINE_RETAIL
( INVOICENO    VARCHAR2(100),
  STOCKCODE    VARCHAR2(100),
  DESCRIPTION  VARCHAR2(200),
  QUANTITY     NUMBER(10,2),
  INVOICEDATE  DATE,
  UNITPRICE    NUMBER(10,2),
  CUSTOMERID  NUMBER(10,2),
  COUNTRY     VARCHAR2(100) );


-- 데이터 입력: SQL Developer를 이용해서 Online Retail.csv 를 ONLINE_RETAIL 테이블에 입력합니다.


SELECT COUNT(*)  FROM ONLINE_RETAIL;

-- 541909 행

-- 2. 연관성 분석을 위한 머신러닝 환경을 셋팅합니다. 

DROP TABLE SETTINGS_ASSOCIATION_RULES2;

CREATE TABLE SETTINGS_ASSOCIATION_RULES2
AS
   SELECT *
     FROM TABLE (DBMS_DATA_MINING.GET_DEFAULT_SETTINGS)
     WHERE SETTING_NAME LIKE 'ASSO_%';

BEGIN
   UPDATE SETTINGS_ASSOCIATION_RULES2
     SET SETTING_VALUE = 3
     WHERE SETTING_NAME = DBMS_DATA_MINING.ASSO_MAX_RULE_LENGTH;

   UPDATE SETTINGS_ASSOCIATION_RULES2
      SET SETTING_VALUE = 0.03
      WHERE SETTING_NAME = DBMS_DATA_MINING.ASSO_MIN_SUPPORT;

    UPDATE SETTINGS_ASSOCIATION_RULES2
      SET SETTING_VALUE = 0.03
      WHERE SETTING_NAME = DBMS_DATA_MINING.ASSO_MIN_CONFIDENCE;

   INSERT INTO SETTINGS_ASSOCIATION_RULES2
      VALUES (DBMS_DATA_MINING.ODMS_ITEM_ID_COLUMN_NAME, ' INVOICENO');
   COMMIT;
END;
/


-- 3. 학습할 데이터만 선별하여 머신러닝 모델을 생성합니다.

BEGIN
  DBMS_DATA_MINING.DROP_MODEL('MD_ASSOC_ANLYSIS2');
END;
/

CREATE OR REPLACE VIEW VW_ONLINE_RETAIL
 AS 
   SELECT INVOICENO, STOCKCODE
       FROM ONLINE_RETAIL;

BEGIN 
   DBMS_DATA_MINING.CREATE_MODEL(
      MODEL_NAME            => 'MD_ASSOC_ANLYSIS2',
      MINING_FUNCTION       => DBMS_DATA_MINING.ASSOCIATION,
      DATA_TABLE_NAME       => 'VW_ONLINE_RETAIL',
      CASE_ID_COLUMN_NAME   => 'STOCKCODE',
      TARGET_COLUMN_NAME    => NULL,
      SETTINGS_TABLE_NAME   => 'SETTINGS_ASSOCIATION_RULES2');
END;
/

-- 4. 머신러닝 모델을 확인합니다. 

SELECT MODEL_NAME,
          ALGORITHM,
          MINING_FUNCTION
  FROM ALL_MINING_MODELS
  WHERE MODEL_NAME = 'MD_ASSOC_ANLYSIS2';

-- 5. 머신러닝 모델의 환경 설정을 확인합니다.

SELECT SETTING_NAME, SETTING_VALUE
  FROM ALL_MINING_MODEL_SETTINGS
  WHERE MODEL_NAME = 'MD_ASSOC_ANLYSIS2';

--6. 모델이 분석한 상품 간의 연관성을 확인합니다. 

SELECT A.ATTRIBUTE_SUBNAME as ANTECEDENT,
       C.ATTRIBUTE_SUBNAME as CONSEQUENT,
       ROUND(RULE_SUPPORT,3) as SUPPORT,
       ROUND(RULE_CONFIDENCE,3) as CONFIDENCE,
       ROUND(RULE_LIFT,3) as LIFT
  FROM  TABLE(DBMS_DATA_MINING.GET_ASSOCIATION_RULES('MD_ASSOC_ANLYSIS2',10)) T,
            TABLE(T.CONSEQUENT) C,
            TABLE(T.ANTECEDENT) A
  ORDER BY SUPPORT DESC, LIFT DESC;




