/* 181.SQL로 머신러닝 구현하기 ③(NAIVEBAYES) */

DROP TABLE MUSHROOMS;

CREATE TABLE MUSHROOMS 
( ID                           NUMBER(10),        
TYPE                          VARCHAR2(10),                    
CAP_SHAPE	       VARCHAR2(10),      
CAP_SURFACE	       VARCHAR2(10),      
CAP_COLOR	       VARCHAR2(10),      
BRUISES	                   VARCHAR2(10),
ODOR	                   VARCHAR2(10),
GILL_ATTACHMENT	       VARCHAR2(10),      
GILL_SPACING	       VARCHAR2(10),      
GILL_SIZE	                   VARCHAR2(10),      
GILL_COLOR	       VARCHAR2(10),      
STALK_SHAPE	       VARCHAR2(10),      
STALK_ROOT	       VARCHAR2(10),      
STALK_SURFACE_ABOVE_RING      VARCHAR2(10),      
STALK_SURFACE_BELOW_RING      VARCHAR2(10),      
STALK_COLOR_ABOVE_RING         VARCHAR2(10),      
STALK_COLOR_BELOW_RING	       VARCHAR2(10),      
VEIL_TYPE	                   VARCHAR2(10),      
VEIL_COLOR	                   VARCHAR2(10),      
RING_NUMBER	                   VARCHAR2(10),      
RING_TYPE	                   VARCHAR2(10),      
SPORE_PRINT_COLOR	       VARCHAR2(10),      
POPULATION	                   VARCHAR2(10),        
HABITAT                                 VARCHAR2(10) );


DROP TABLE MUSHROOMS_TRAINING;

CREATE TABLE MUSHROOMS_TRAINING 
AS
SELECT *
  FROM MUSHROOMS
  WHERE ID < 7312;

DROP TABLE MUSHROOMS_TEST; 

CREATE TABLE MUSHROOMS_TEST
AS
   SELECT *
     FROM MUSHROOMS
    WHERE ID >= 7312;

DROP TABLE SETTINGS_GLM;

CREATE TABLE SETTINGS_GLM
AS
SELECT *
     FROM TABLE (DBMS_DATA_MINING.GET_DEFAULT_SETTINGS)
    WHERE SETTING_NAME LIKE '%GLM%';

BEGIN

   INSERT INTO SETTINGS_GLM
        VALUES (DBMS_DATA_MINING.ALGO_NAME, 'ALGO_NAIVE_BAYES');

   INSERT INTO SETTINGS_GLM
        VALUES (DBMS_DATA_MINING.PREP_AUTO, 'ON');

   COMMIT;

END;

-- 4. 머신러닝 모델을 생성합니다. 

BEGIN
  DBMS_DATA_MINING.DROP_MODEL('MD_CLASSIFICATION_MODEL');
END;
/

BEGIN 
   DBMS_DATA_MINING.CREATE_MODEL(
      MODEL_NAME           => 'MD_CLASSIFICATION_MODEL',
      MINING_FUNCTION      => DBMS_DATA_MINING.CLASSIFICATION,
      DATA_TABLE_NAME       => 'MUSHROOMS',
      CASE_ID_COLUMN_NAME   => 'ID',
      TARGET_COLUMN_NAME   => 'TYPE',
      SETTINGS_TABLE_NAME   => 'SETTINGS_GLM');
END;
/


-- 5. 머신러닝 모델이 잘 생성되었는지 확인합니다. 

SELECT MODEL_NAME,
          ALGORITHM,
          CREATION_DATE,
          MINING_FUNCTION
  FROM ALL_MINING_MODELS
  WHERE MODEL_NAME = 'MD_CLASSIFICATION_MODEL';

-- 6. 머신러닝 모델 구성 정보를 확인합니다. 

SELECT SETTING_NAME, SETTING_VALUE
  FROM ALL_MINING_MODEL_SETTINGS
  WHERE MODEL_NAME = 'MD_CLASSIFICATION_MODEL';

-- 7. 나이브 베이즈 머신러닝 모델이 테스트 데이터에 대해 예측한 값을 확인합니다. 

SELECT ID, CAP_SHAPE, CAP_SURFACE, CAP_COLOR, BRUISES, ODOR, TYPE 실제값,
          PREDICTION (MD_CLASSIFICATION_MODEL USING *) 예측값
  FROM MUSHROOMS_TEST T
  WHERE id in (7620, 7621, 7622, 7623);

-- 8. 나이브 베이즈 머신러닝 모델의 정확도를 확인합니다.

SELECT SUM(DECODE(P.MODEL_PREDICT_RESPONSE, I.TYPE, 1,0)) / COUNT(*) 정확도
  FROM (
             SELECT ID, PREDICTION (MD_CLASSIFICATION_MODEL USING *) MODEL_PREDICT_RESPONSE
               FROM MUSHROOMS_TEST T )  P,  MUSHROOMS  I
  WHERE P.ID= I.ID;